<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ â€” Ø¨ÙˆØª ØµÙˆØªÙŠ</title>
<style>
  /* (Ù…ÙˆØ¬ÙˆØ¯ Ø³ØªØ§ÙŠÙ„ Ø¨Ø³ÙŠØ· - ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ù…Ù‚ØµÙ‘Ø¨Ù„Ø§Ù‹) */
  body{margin:0;font-family:Arial, Tahoma;background:linear-gradient(135deg,#071226,#10293a);color:#eef2ff;display:flex;align-items:center;justify-content:center;height:100vh}
  .box{width:95%;max-width:900px;background:rgba(255,255,255,0.02);padding:16px;border-radius:12px}
  .center{display:flex;gap:12px;align-items:center}
  .robot{width:80px;height:80px;border-radius:16px;background:linear-gradient(135deg,#7C4DFF,#00D4FF);display:flex;align-items:center;justify-content:center;font-size:36px}
  .transcript{height:260px;overflow:auto;background:rgba(0,0,0,0.25);padding:12px;border-radius:10px;margin-top:12px}
  .bubble{padding:8px 12px;border-radius:12px;margin-bottom:10px;max-width:80%}
  .bot{background:linear-gradient(90deg,#7C4DFF,#00D4FF);color:#fff;align-self:flex-start}
  .user{background:rgba(255,255,255,0.06);color:#fff;align-self:flex-end}
  .controls{display:flex;gap:8px;margin-top:12px}
  button{padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
  .primary{background:linear-gradient(90deg,#7C4DFF,#00D4FF);color:#fff}
  .danger{background:#ff4757;color:#fff}
</style>
</head>
<body>
  <div class="box" role="main" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="robot">ğŸ¤–</div>
        <div>
          <div style="font-weight:800">Ø±ÙˆØ¨ÙˆØª Ø§Ù„Ù‚Ø§Ø¹Ø©</div>
          <div id="botStatus" style="font-size:13px;color:rgba(255,255,255,0.75)">Ù…ÙˆÙ‚ÙˆÙ â€” Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£</div>
        </div>
      </div>
      <div>
        <button id="startBtn" class="primary">Ø§Ø¨Ø¯Ø£ (Ø¥Ø°Ù† ØµÙˆØª)</button>
      </div>
    </div>

    <div id="transcript" class="transcript" aria-live="polite"></div>

    <div class="controls">
      <button id="toggleListen">Ø¥ÙŠÙ‚Ø§Ù/ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</button>
      <button id="stopBtn" class="danger">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª</button>
    </div>
  </div>

<script>
/* ======= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù‡Ù…Ø© ======= */
let SERVER_API = 'https://YOUR-VERCEL-APP.vercel.app/api/chat'; // <-- Ø¹ÙŠÙ‘Ù†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø¹Ø¯ Ù†Ø´Ø± Ø§Ù„Ù€ backend
/* ============================ */

const startBtn = document.getElementById('startBtn');
const toggleListenBtn = document.getElementById('toggleListen');
const stopBtn = document.getElementById('stopBtn');
const transcriptEl = document.getElementById('transcript');
const botStatus = document.getElementById('botStatus');

let recognition = null;
let listening = false;
let botActive = false;
const synth = window.speechSynthesis;

function addBubble(txt, who='bot'){
  const d = document.createElement('div');
  d.className = 'bubble ' + (who==='bot' ? 'bot' : 'user');
  d.textContent = txt;
  transcriptEl.appendChild(d);
  transcriptEl.scrollTop = transcriptEl.scrollHeight;
}

function speakText(text, onend){
  if(!synth){ if(onend) onend(); return; }
  synth.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ar-SA';
  u.rate = 1;
  u.pitch = 1;
  u.onend = ()=> onend && onend();
  // optional: pick a voice that contains 'ar' if available
  const voices = synth.getVoices();
  const arVoice = voices.find(v=>v.lang && v.lang.startsWith('ar'));
  if(arVoice) u.voice = arVoice;
  synth.speak(u);
}

function setupRecognition(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition) { botStatus.textContent='Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹'; return null; }
  const r = new SpeechRecognition();
  r.lang = 'ar-SA';
  r.interimResults = false;
  r.continuous = false;
  r.onstart = ()=> { listening = true; botStatus.textContent='Ø§Ø³ØªÙ…Ø§Ø¹...'; toggleListenBtn.textContent='Ø£ÙˆÙ‚Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹'; };
  r.onend = ()=> { listening = false; botStatus.textContent= botActive ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹' : 'Ù…ÙˆÙ‚ÙˆÙ'; toggleListenBtn.textContent='ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹'; };
  r.onerror = (e)=> { console.warn('STT error', e); botStatus.textContent='Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹'; };
  r.onresult = async (ev)=>{
    const text = ev.results[0][0].transcript.trim();
    addBubble(text, 'user');
    botStatus.textContent='Ø¬Ø§Ø±Ù Ø§Ù„ØªÙÙƒÙŠØ±...';
    try{
      const reply = await fetchReply(text);
      addBubble(reply, 'bot');
      speakText(reply, ()=> { if(botActive) startListening(); botStatus.textContent='Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹'; });
    }catch(err){
      console.error(err);
      addBubble('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù….', 'bot');
      botStatus.textContent='Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
    }
  };
  return r;
}

async function fetchReply(userText){
  // ÙŠÙ†Ø§Ø¯ÙŠ Ø§Ù„Ù€ backend proxy Ø§Ù„Ø°ÙŠ ÙŠØªØ­Ø¯Ø« Ù…Ø¹ OpenAI â€” Ù‡ÙƒØ°Ø§ Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„.
  const res = await fetch(SERVER_API, {
    method:'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ message: userText })
  });
  if(!res.ok) throw new Error('server error');
  const json = await res.json();
  return json.reply || 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØµÙ„ Ø±Ø¯.';
}

function startListening(){
  if(!recognition) recognition = setupRecognition();
  try{ recognition.start(); }catch(e){ recognition = setupRecognition(); recognition.start(); }
}

startBtn.addEventListener('click', ()=>{
  // Ø²Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ‘Ù„ â€” ÙŠØªÙŠØ­ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ TTS/Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
  botActive = true;
  botStatus.textContent = 'ØªØ´ØºÙŠÙ„...';
  // ØªØ­ÙŠØ© Ø£ÙˆÙ„ÙŠØ© Ø«Ù… Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
  addBubble('Ø£Ù‡Ù„Ù‹Ø§! Ø§Ø³Ù…ÙŠ Ø±ÙˆØ¨ÙˆØª Ø§Ù„Ù‚Ø§Ø¹Ø© â€” ØªÙØ¶Ù‘Ù„ ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†.', 'bot');
  speakText('Ø£Ù‡Ù„Ù‹Ø§! Ø§Ø³Ù…ÙŠ Ø±ÙˆØ¨ÙˆØª Ø§Ù„Ù‚Ø§Ø¹Ø©. ØªÙØ¶Ù‘Ù„ ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†.', ()=> startListening());
});

toggleListenBtn.addEventListener('click', ()=> {
  if(!recognition) return;
  if(listening){ recognition.stop(); } else startListening();
});

stopBtn.addEventListener('click', ()=> {
  botActive = false;
  if(recognition) recognition.stop();
  if(synth) synth.cancel();
  botStatus.textContent='Ù…ÙˆÙ‚ÙˆÙ';
  addBubble('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª.', 'bot');
});
</script>
</body>

</html>
